---
name: 'Reece specific Helm packaging, publishing and pinning'
description: |
  Packages a Helm chart - including Cloudformation templates if they exist, which is a reecetech specific thing to do.
  Publishes the Helm chart to Artifactory, again following reecetech specific naming of Helm chart Artifactory
  repositories - `helm-local` & `helm-local-stable`.
  Pins the Helm chart version to a reecetech specific `kubernetes-configuration-files` repository commit ID.
  Authentication for Artifactory and AWS is handled via OIDC integrations between GitHub and reecetech Vault & AWS
  accounts.

branding:
  icon: plus
  color: purple

inputs:
  name:
    description: 'Name of the Helm chart'
    required: true
  version:
    description: 'Version of the Helm chart'
    required: true
  vault_url:
    description: 'URL to access Vault'
    required: false
    default: '${{ secrets.VAULT_PRODUCTION }}'
  stash_ad_creds_path:
    descrition: 'Path to the Stash AD creds in Vault'
    required: false
    default: '${{ inputs.STASH_AD_CREDS_PATH }}'

outputs:
  chart:
    description: 'The filename of the Helm chart produced'
    value: ${{ steps.package.outputs.chart }}

runs:
  using: "composite"
  steps:
    - id: vault
      name: Obtain Vault token and Stash credentials
      uses: hashicorp/vault-action@v2.4.0
      with:
        url: ${{ inputs.vault_url }}
        role: ${{ github.repository_owner }}
        method: jwt
        path: github
        exportToken: true  # get the Vault token as well, to be used in `artifactory-credentials`
        secrets: |
          ${{ inputs.stash_ad_creds_path }} username | stash_ad_username ;
          ${{ inputs.stash_ad_creds_path }} current_password | stash_ad_password

    - id: artifactory
      name: Obtain Artifactory credentials
      shell: bash
      env:
        token: ${{ secrets.VAULT_TOKEN }}
        url: ${{ secrets.VAULT_PRODUCTION }}
        path: ${{ secrets.ARTIFACTORY_CREDS_PATH }}
      # until `hashicorp/vault-action` supports secrets engines that need `write` we have to run our own script
      run: ${{ github.action_path }}/artifactory-creds-from-vault.sh

    - id: stash
      name: Obtain a PAT to use with Stash
      uses: reecetech/bitbucket-server-pat-generator@fixup-input-var-use
      with:
        base_url: ${{ secrets.STASH_PRODUCTION }}
        username: ${{ steps.vault.outputs.stash_ad_username }}
        password: ${{ steps.vault.outputs.stash_ad_password }}

    - id: package
      name: Package a Helm Chart
      shell: bash
      env:
        name: ${{ inputs.name }}
        version: ${{ inputs.version }}
      run: ${{ github.action_path }}/helm-package-with-cloudformation.sh

    - id: publish
      name: Publish a Helm Chart
      shell: bash
      env:
        chart: ${{ steps.package.outputs.chart }}
        version: ${{ inputs.version }}
        url: ${{ secrets.ARTIFACTORY_PRODUCTION }}
        username: ${{ steps.artifactory.outputs.username }}
        password: ${{ steps.artifactory.outputs.password }}
      run: ${{ github.action_path }}/helm-publish-to-artifactory.sh

    - id: aws
      name: Obtain AWS keys
      uses: aws-actions/configure-aws-credentials@v1
      with:
        role-to-assume: ${{ secrets.BARNACLE_ROLE }}
        aws-region: ${{ secrets.BARNACLE_REGION }}
