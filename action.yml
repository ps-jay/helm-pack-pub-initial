---
name: 'Reece specific Helm packaging, publishing and pinning'
description: |
  Packages a Helm chart - including Cloudformation templates if they exist, which is a reecetech specific thing to do.
  Publishes the Helm chart to Artifactory, again following reecetech specific naming of Helm chart Artifactory
  repositories - `helm-local` & `helm-local-stable`.
  Pins the Helm chart version to a reecetech specific `kubernetes-configuration-files` repository commit ID.
  Authentication for Artifactory and AWS is handled via OIDC integrations between GitHub and reecetech Vault & AWS
  accounts.

branding:
  icon: plus
  color: purple

inputs:
  name:
    description: 'Name of the Helm chart'
    required: true
  version:
    description: 'Version of the Helm chart'
    required: true
  artifactory_creds_path:
    description: 'Path to obtain Artifactory creds from Vault'
    required: false
    default: 'artifactory/token/common-pipeline'
  artifactory_url:
    description: 'Base URL to access Artifactory'
    required: false
    default: 'https://artifactory.reecenet.org/artifactory'
  barnacle_region:
    description: 'AWS region for the Barnacle DynamoDB table'
    required: false
    default: 'ap-southeast-2'
  barnacle_role:
    description: 'AWS role to assume to write to the Barnacle DynamoDB table'
    required: true
  stash_ad_creds_path:
    description: 'Path to obtain Stash AD creds from Vault'
    required: false
    default: 'ad/creds/svc_prod_gh_stash'
  stash_url:
    description: 'Base URL to access Stash'
    required: false
    default: 'https://stash.reecenet.org'
  vault_url:
    description: 'Base URL to access Vault'
    required: false
    default: 'https://vault.security-prod.reecenet.org'

outputs:
  chart:
    description: 'The filename of the Helm chart produced'
    value: ${{ steps.package.outputs.chart }}

runs:
  using: "composite"
  steps:
    - id: vault
      name: Obtain Vault token and Stash credentials
      uses: hashicorp/vault-action@v2.4.0
      with:
        url: ${{ inputs.vault_url }}
        role: ${{ github.repository_owner }}
        method: jwt
        path: github
        exportToken: true  # get the Vault token as well, to be used in `artifactory-credentials`
        secrets: |
          /${{ inputs.stash_ad_creds_path }} username | stash_ad_username ;
          /${{ inputs.stash_ad_creds_path }} current_password | stash_ad_password

    - id: artifactory
      name: Obtain Artifactory credentials
      shell: bash
      env:
        token: ${{ env.VAULT_TOKEN }}
        url: ${{ inputs.vault_url }}
        path: ${{ inputs.artifactory_creds_path }}
      # until `hashicorp/vault-action` supports secrets engines that need `write` we have to run our own script
      run: ${{ github.action_path }}/artifactory-creds-from-vault.sh

    - id: stash
      name: Obtain a PAT to use with Stash
      uses: reecetech/bitbucket-server-pat-generator@fixup-input-var-use
      with:
        base_url: ${{ inputs.stash_url }}
        username: ${{ steps.vault.outputs.stash_ad_username }}
        password: ${{ steps.vault.outputs.stash_ad_password }}

    - id: package
      name: Package a Helm Chart
      shell: bash
      env:
        name: ${{ inputs.name }}
        version: ${{ inputs.version }}
      run: ${{ github.action_path }}/helm-package-with-cloudformation.sh

    - id: publish
      name: Publish a Helm Chart
      shell: bash
      env:
        chart: ${{ steps.package.outputs.chart }}
        version: ${{ inputs.version }}
        url: ${{ inputs.artifactory_url }}
        username: ${{ steps.artifactory.outputs.username }}
        password: ${{ steps.artifactory.outputs.password }}
      run: ${{ github.action_path }}/helm-publish-to-artifactory.sh

    - id: aws
      name: Obtain AWS keys
      uses: aws-actions/configure-aws-credentials@v1
      with:
        role-to-assume: ${{ inputs.barnacle_role }}
        aws-region: ${{ inputs.barnacle_region }}
